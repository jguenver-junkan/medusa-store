import{C as R,b as K,u as Z,S as J,a as Q}from"./chunk-FCEISMFM-BmOCbU3E.js";import{S as U,C as k}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{f as X}from"./chunk-IR5DHEKS-aVJcUHa1.js";import{u as B}from"./chunk-6CNRNROJ-DQ0GP8d6.js";import{C as $}from"./chunk-W6N53UNG-B1QpwSpL.js";import{D as Y}from"./chunk-ZF4OL2GU-DR2dd5g5.js";import{a5 as n,R as ee,a6 as se,aS as ie,ar as re,j as e,r as E,b as H,a8 as oe,a9 as ne,t as q,B as M,s as A,H as te,T as ae,w as o,x as ce,D as le,g as pe,i as de,l as ue,v as me}from"./index-oLtKV1Ux.js";import"./chunk-BNLHRJ2A-Dbt8kFSd.js";import{b as he}from"./chunk-STLKFKTM-Bvil_KZP.js";import{S as ge}from"./chunk-JLD5AXG6-9JXHz8FI.js";import{c as F}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as fe}from"./chunk-6HTZNHPT-DsPxpq1N.js";import{R as w,u as G,a as xe,S as _e}from"./chunk-6DAFMWMA-DcFXWLP6.js";import{P}from"./progress-tabs-DhL0_rOD.js";import{R as V}from"./radio-group-Bd2ge9yQ.js";import"./chunk-FSMQADBD-DQ6u7KYm.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./index.esm-WiAENjKK.js";import"./x-mark-mini-CknGqCj5.js";import"./Trans-BliKkizb.js";import"./currency-input-DVzab5bf.js";import"./triangles-mini-DH8IYMeu.js";import"./plus-mini-Dt4gvBBt.js";import"./index-CgI6BRDf.js";import"./checkbox-DUCWB_Nj.js";import"./prompt-D1yV89PX.js";var je=({form:t,isReturn:g=!1,zone:f,locationId:u})=>{const{t:r}=H(),d=B({queryFn:s=>A.admin.shippingProfile.list(s),queryKey:["shipping_profiles"],getOptions:s=>s.shipping_profiles.map(h=>({label:h.name,value:h.id}))}),m=B({queryFn:s=>A.admin.fulfillmentProvider.list({...s,stock_location_id:u}),queryKey:["fulfillment_providers"],getOptions:s=>s.fulfillment_providers.map(h=>({label:X(h.id),value:h.id}))});return e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-6 py-16",children:[e.jsxs("div",{children:[e.jsx(te,{children:r(`stockLocations.shippingOptions.create.${g?"returns":"shipping"}.header`,{zone:f.name})}),e.jsx(ae,{size:"small",className:"text-ui-fg-subtle",children:r(`stockLocations.shippingOptions.create.${g?"returns":"shipping"}.hint`)})]}),e.jsx(o.Field,{control:t.control,name:"price_type",render:({field:s})=>e.jsxs(o.Item,{children:[e.jsx(o.Label,{children:r("stockLocations.shippingOptions.fields.priceType.label")}),e.jsx(o.Control,{children:e.jsxs(V,{className:"grid grid-cols-1 gap-4 md:grid-cols-2",...s,onValueChange:s.onChange,children:[e.jsx(V.ChoiceBox,{className:"flex-1",value:"flat",label:r("stockLocations.shippingOptions.fields.priceType.options.fixed.label"),description:r("stockLocations.shippingOptions.fields.priceType.options.fixed.hint")}),e.jsx(V.ChoiceBox,{className:"flex-1",value:"calculated",label:r("stockLocations.shippingOptions.fields.priceType.options.calculated.label"),description:r("stockLocations.shippingOptions.fields.priceType.options.calculated.hint")})]})}),e.jsx(o.ErrorMessage,{})]})}),e.jsx("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:e.jsx(o.Field,{control:t.control,name:"name",render:({field:s})=>e.jsxs(o.Item,{children:[e.jsx(o.Label,{children:r("fields.name")}),e.jsx(o.Control,{children:e.jsx(ce,{...s})}),e.jsx(o.ErrorMessage,{})]})})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(o.Field,{control:t.control,name:"shipping_profile_id",render:({field:s})=>e.jsxs(o.Item,{children:[e.jsx(o.Label,{children:r("stockLocations.shippingOptions.fields.profile")}),e.jsx(o.Control,{children:e.jsx($,{...s,options:d.options,searchValue:d.searchValue,onSearchValueChange:d.onSearchValueChange,disabled:d.disabled})}),e.jsx(o.ErrorMessage,{})]})}),e.jsx(o.Field,{control:t.control,name:"provider_id",render:({field:s})=>e.jsxs(o.Item,{children:[e.jsx(o.Label,{tooltip:r("stockLocations.fulfillmentProviders.shippingOptionsTooltip"),children:r("stockLocations.shippingOptions.fields.provider")}),e.jsx(o.Control,{children:e.jsx($,{...s,options:m.options,searchValue:m.searchValue,onSearchValueChange:m.onSearchValueChange,disabled:m.disabled})}),e.jsx(o.ErrorMessage,{})]})})]}),e.jsx(le,{}),e.jsx(ge,{control:t.control,name:"enabled_in_store",label:r("stockLocations.shippingOptions.fields.enableInStore.label"),description:r("stockLocations.shippingOptions.fields.enableInStore.hint")})]})})},be=({form:t})=>{const{getIsOpen:g,setIsOpen:f}=xe(),[u,r]=E.useState(null),d=l=>{f(k,!0),r(l)},m=()=>{f(k,!1),r(null)},{store:s,isLoading:h,isError:a,error:_}=pe(),y=E.useMemo(()=>{var l;return((l=s==null?void 0:s.supported_currencies)==null?void 0:l.map(C=>C.currency_code))||[]},[s]),{regions:x,isLoading:S,isError:j,error:D}=de({fields:"id,name,currency_code",limit:999}),{price_preferences:I}=ue({}),{setCloseOnEscape:N}=G(),T=me({control:t.control,name:"name"}),i=Z({name:T,currencies:y,regions:x,pricePreferences:I}),v=h||!s||S||!x,b=E.useMemo(()=>[[...y||[],...x||[]]],[y,x]);if(a)throw _;if(j)throw D;return e.jsx(_e,{id:k,onOpenChangeCallback:l=>{l||r(null)},children:e.jsx(J,{onOpenConditionalPricesModal:d,onCloseConditionalPricesModal:m,children:e.jsxs("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:[e.jsx(Y,{isLoading:v,data:b,columns:i,state:t,onEditingChange:l=>N(!l),disableInteractions:g(k)}),u&&e.jsx(Q,{info:u,variant:"create"})]})})})},W=n.object({name:n.string().min(1),price_type:n.nativeEnum(U),enabled_in_store:n.boolean(),shipping_profile_id:n.string().min(1),provider_id:n.string().min(1)}),ye=n.object({conditional_region_prices:n.record(n.string(),n.array(R).optional()),conditional_currency_prices:n.record(n.string(),n.array(R).optional())}),ve=n.object({region_prices:n.record(n.string(),n.string().optional()),currency_prices:n.record(n.string(),n.string().optional())}).merge(W).merge(ye);function Se({zone:t,isReturn:g,locationId:f}){var N,T;const[u,r]=E.useState("details"),[d,m]=E.useState(!1),{t:s}=H(),{handleSuccess:h}=G(),a=oe({defaultValues:{name:"",price_type:"flat",enabled_in_store:!0,shipping_profile_id:"",provider_id:"",region_prices:{},currency_prices:{},conditional_region_prices:{},conditional_currency_prices:{}},resolver:ne(ve)}),_=a.watch("price_type")==="calculated",{mutateAsync:y,isPending:x}=he(),S=a.handleSubmit(async i=>{const v=Object.entries(i.currency_prices).map(([c,p])=>{if(p)return{currency_code:c,amount:F(p)}}).filter(c=>!!c),b=Object.entries(i.region_prices).map(([c,p])=>{if(p)return{region_id:c,amount:F(p)}}).filter(c=>!!c),l=Object.entries(i.conditional_region_prices).flatMap(([c,p])=>{const O=(p==null?void 0:p.map(L=>({region_id:c,amount:F(L.amount),rules:K(L)})))||[];return O==null?void 0:O.filter(Boolean)}),C=Object.entries(i.conditional_currency_prices).flatMap(([c,p])=>{const O=(p==null?void 0:p.map(L=>({currency_code:c,amount:F(L.amount),rules:K(L)})))||[];return O==null?void 0:O.filter(Boolean)}),z=[...v,...C,...b,...l];await y({name:i.name,price_type:i.price_type,service_zone_id:t.id,shipping_profile_id:i.shipping_profile_id,provider_id:i.provider_id,prices:z,rules:[{value:g?'"true"':'"false"',attribute:"is_return",operator:"eq"},{value:i.enabled_in_store?'"true"':'"false"',attribute:"enabled_in_store",operator:"eq"}],type:{label:"Type label",description:"Type description",code:"type-code"}},{onSuccess:({shipping_option:c})=>{q.success(s(`stockLocations.shippingOptions.create.${g?"returns":"shipping"}.successToast`,{name:c.name})),h(`/settings/locations/${f}`)},onError:c=>{q.error(c.message)}})}),j=i=>{if(i==="pricing"){a.clearErrors();const v=W.safeParse({...a.getValues()});if(!v.success){const[b,...l]=v.error.errors;for(const C of l){const z=C.path.join(".");a.setError(z,{message:C.message,type:C.code})}a.setError(b.path.join("."),{message:b.message,type:b.code},{shouldFocus:!0}),m(!1);return}m(!0)}r(i)},D=(N=a.getFieldState("currency_prices"))!=null&&N.isDirty||(T=a.getFieldState("region_prices"))!=null&&T.isDirty||u==="pricing"?"in-progress":"not-started",I=d?"completed":"in-progress";return e.jsx(w.Form,{form:a,children:e.jsx(fe,{className:"flex h-full flex-col",onSubmit:S,onKeyDown:i=>{const v=i.key==="Enter",b=i.metaKey||i.ctrlKey,l=u!=="pricing"&&!_;if(v&&(i.preventDefault(),!!b)){if(l){i.stopPropagation(),j("pricing");return}S()}},children:e.jsxs(P,{value:u,className:"flex h-full flex-col overflow-hidden",onValueChange:i=>j(i),children:[e.jsx(w.Header,{children:e.jsxs(P.List,{className:"border-ui-border-base -my-2 ml-2 min-w-0 flex-1 border-l",children:[e.jsx(P.Trigger,{value:"details",status:I,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full cursor-auto overflow-hidden text-ellipsis whitespace-nowrap",children:s("stockLocations.shippingOptions.create.tabs.details")})}),!_&&e.jsx(P.Trigger,{value:"pricing",status:D,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full overflow-hidden text-ellipsis whitespace-nowrap",children:s("stockLocations.shippingOptions.create.tabs.prices")})})]})}),e.jsxs(w.Body,{className:"size-full overflow-hidden",children:[e.jsx(P.Content,{value:"details",className:"size-full overflow-y-auto",children:e.jsx(je,{form:a,zone:t,isReturn:g,locationId:f})}),e.jsx(P.Content,{value:"pricing",className:"size-full",children:e.jsx(be,{form:a})})]}),e.jsx(w.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(M,{variant:"secondary",size:"small",children:s("actions.cancel")})}),u==="pricing"||_?e.jsx(M,{size:"small",className:"whitespace-nowrap",isLoading:x,type:"submit",children:s("actions.save")},"submit-btn"):e.jsx(M,{size:"small",className:"whitespace-nowrap",isLoading:x,onClick:()=>j("pricing"),type:"button",children:s("actions.continue")},"continue-btn")]})})]})})})}var Ce="*fulfillment_sets,*fulfillment_sets.service_zones,*fulfillment_sets.service_zones.shipping_options";function Ue(){var y,x,S;const{location_id:t,fset_id:g,zone_id:f}=ee(),[u]=se(),r=u.has("is_return"),{stock_location:d,isPending:m,isFetching:s,isError:h,error:a}=ie(t,{fields:Ce}),_=(S=(x=(y=d==null?void 0:d.fulfillment_sets)==null?void 0:y.find(j=>j.id===g))==null?void 0:x.service_zones)==null?void 0:S.find(j=>j.id===f);if(!m&&!s&&!_)throw re({message:`Service zone with ID ${f} was not found`},404);if(h)throw a;return e.jsx(w,{prev:`/settings/locations/${t}`,children:_&&e.jsx(Se,{zone:_,isReturn:r,locationId:t})})}export{Ue as Component};
